{% extends 'admin/base_admin.html.twig' %}

{% block title %}Gestion des utilisateurs{% endblock %}

{% block page_title %}Gestion des utilisateurs{% endblock %}
{% block breadcrumb %}Utilisateurs{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('assets/css/adminlte-custom.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .user-actions .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    async function updateUser(event, userId) {
        try {
            const form = document.getElementById(`editUserForm${userId}`);
            if (!form) {
                throw new Error('Formulaire non trouvé');
            }

            // Supprimer les anciennes alertes
            form.querySelectorAll('.alert').forEach(alert => alert.remove());
            document.querySelectorAll('.alert-ajax').forEach(alert => alert.remove());

            // Désactiver le bouton de soumission
            const submitButton = form.querySelector('button.btn-primary');
            if (!submitButton) {
                throw new Error('Bouton de soumission non trouvé');
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

            // Préparer les données
            const formData = new FormData();
            const fields = {
                '_token': 'input[name="_token"]',
                'nom': 'input[name="nom"]',
                'prenom': 'input[name="prenom"]',
                'email': 'input[name="email"]',
                'password': 'input[name="password"]',
                'type_utilisateur': 'select[name="type_utilisateur"]',
                'telephone': 'input[name="telephone"]'
            };
            
            // Ajouter les conditions d'utilisation automatiquement
            formData.append('conditions', 'on');

            // Vérifier et ajouter chaque champ
            for (const [key, selector] of Object.entries(fields)) {
                const element = form.querySelector(selector);
                if (!element) {
                    throw new Error(`Champ ${key} non trouvé`);
                }
                formData.append(key, element.value);
            }

            // Construire l'URL de l'API
            const url = `{{ path('api_user_edit', {'id': '__USER_ID__'}) }}`.replace('__USER_ID__', userId);

            console.log('Envoi de la requête à URL:', url);
            console.log('Données du formulaire:', Object.fromEntries(formData.entries()));
            
            // Envoyer la requête
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                // S'assurer que les cookies sont envoyés avec la requête
                credentials: 'same-origin'
            });

            // Vérifier d'abord le type de contenu
            const contentType = response.headers.get('content-type');
            console.log('Type de contenu de la réponse:', contentType);
            
            // Récupérer la réponse
            let data;
            if (contentType && contentType.includes('application/json')) {
                try {
                    data = await response.json();
                    console.log('Réponse JSON reçue:', data);
                } catch (jsonError) {
                    console.error('Erreur lors du parsing JSON:', jsonError);
                    throw new Error(`Erreur lors du parsing de la réponse JSON: ${jsonError.message}`);
                }
            } else {
                // Si ce n'est pas du JSON, récupérer le texte
                const text = await response.text();
                console.error('Réponse non-JSON reçue:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: contentType,
                    body: text,
                    url: url
                });
                throw new Error(`Réponse invalide du serveur (Status: ${response.status}, Content-Type: ${contentType || 'non défini'})`);
            }

            // Vérifier si la réponse est OK
            if (!response.ok) {
                throw new Error(data.message || `Erreur HTTP: ${response.status} ${response.statusText}`);
            }

            if (!data.success) {
                throw new Error(data.message || 'Erreur lors de la modification');
            }

            // Redirection simple vers la page des utilisateurs
            window.location.href = "{{ path('admin_users') }}";



            // Réinitialiser le mot de passe
            const passwordInput = form.querySelector('input[name="password"]');
            if (passwordInput) {
                passwordInput.value = '';
            }

        } catch (error) {
            console.error('Erreur lors de la modification:', error);
            
            // Afficher l'erreur dans le formulaire
            const form = document.getElementById(`editUserForm${userId}`);
            if (form) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = error.message;
                form.insertBefore(errorDiv, form.firstChild);
            }
            
            // Afficher également l'erreur en haut de la page
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show alert-ajax';
            alertDiv.innerHTML = `
                Erreur: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            const container = document.querySelector('.container-fluid');
            const card = document.querySelector('.card');
            if (container && card) {
                container.insertBefore(alertDiv, card);
                setTimeout(() => alertDiv.remove(), 5000);
            }
        } finally {
            // Réactiver le bouton de soumission
            const form = document.getElementById(`editUserForm${userId}`);
            if (form) {
                const submitButton = form.querySelector('button.btn-primary');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Enregistrer les modifications';
                }
            }
        }
    }
    </script>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endfor %}
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="card-title">Liste des utilisateurs</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="bi bi-person-plus me-2"></i>Ajouter un utilisateur
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Prénom</th>
                                <th>Email</th>
                                <th>Téléphone</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>{{ user.id }}</td>
                                <td>{{ user.nom }}</td>
                                <td>{{ user.prenom }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.telephone }}</td>
                                <td>{{ user.typeUtilisateur }}</td>
                                <td class="user-actions">
                                    <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal{{ user.id }}" title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </button>

                                    <!-- Modal d'édition pour l'utilisateur {{ user.id }} -->
                                    <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1" aria-labelledby="editUserModalLabel{{ user.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editUserModalLabel{{ user.id }}">Modifier l'utilisateur</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="editUserForm{{ user.id }}">
                                                        <input type="hidden" name="_token" value="{{ csrf_token('edit' ~ user.id) }}">
                                                        <div class="mb-3">
                                                            <label for="nom{{ user.id }}" class="form-label">Nom</label>
                                                            <input type="text" class="form-control" id="nom{{ user.id }}" name="nom" value="{{ user.nom }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="prenom{{ user.id }}" class="form-label">Prénom</label>
                                                            <input type="text" class="form-control" id="prenom{{ user.id }}" name="prenom" value="{{ user.prenom }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="email{{ user.id }}" class="form-label">Email</label>
                                                            <input type="email" class="form-control" id="email{{ user.id }}" name="email" value="{{ user.email }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="password{{ user.id }}" class="form-label">Mot de passe</label>
                                                            <input type="password" class="form-control" id="password{{ user.id }}" name="password" placeholder="Laissez vide pour ne pas modifier">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="type_utilisateur{{ user.id }}" class="form-label">Type d'utilisateur</label>
                                                            <select class="form-select" id="type_utilisateur{{ user.id }}" name="type_utilisateur" required>
                                                                <option value="admin" {{ user.typeUtilisateur == 'admin' or user.typeUtilisateur == 'ROLE_ADMIN' ? 'selected' : '' }}>Administrateur</option>
                                                                <option value="freelance" {{ user.typeUtilisateur == 'freelance' ? 'selected' : '' }}>Freelance</option>
                                                                <option value="formateur" {{ user.typeUtilisateur == 'formateur' ? 'selected' : '' }}>Formateur</option>
                                                                <option value="employeur" {{ user.typeUtilisateur == 'employeur' ? 'selected' : '' }}>Employeur</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="telephone{{ user.id }}" class="form-label">Téléphone</label>
                                                            <input type="tel" class="form-control" id="telephone{{ user.id }}" name="telephone" value="{{ user.telephone }}" pattern="[0-9]{8}" title="Le numéro de téléphone doit contenir 8 chiffres" required>
                                                            <small class="form-text text-muted">Format: 8 chiffres sans espaces (ex: 12345678)</small>
                                                        </div>

                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                                            <button type="button" class="btn btn-primary" onclick="updateUser(event, {{ user.id }})">Enregistrer les modifications</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-danger btn-sm delete-user" data-bs-toggle="modal" data-bs-target="#deleteUserModal{{ user.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Ajouter un utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ path('admin_user_new') }}" method="POST" id="addUserForm">
                        <input type="hidden" name="_token" value="{{ csrf_token('new') }}">
                        <div class="mb-3">
                            <label for="nom" class="form-label">Nom</label>
                            <input type="text" class="form-control" id="nom" name="nom" required>
                        </div>
                        <div class="mb-3">
                            <label for="prenom" class="form-label">Prénom</label>
                            <input type="text" class="form-control" id="prenom" name="prenom" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="type_utilisateur" class="form-label">Type d'utilisateur</label>
                            <select class="form-select" id="type_utilisateur" name="type_utilisateur" required>
                                <option value="">Choisir un type</option>
                                <option value="admin">Administrateur</option>
                                <option value="freelance">Freelance</option>
                                <option value="formateur">Formateur</option>
                                <option value="employeur">Employeur</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="telephone" class="form-label">Téléphone</label>
                            <input type="tel" class="form-control" id="telephone" name="telephone" pattern="[0-9]{8}" title="Le numéro de téléphone doit contenir 8 chiffres">
                            <small class="form-text text-muted">Format: 8 chiffres sans espaces (ex: 12345678)</small>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            <button type="submit" class="btn btn-primary">Ajouter</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Afficher les messages flash dans la modal si nécessaire
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    var alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-{{ label }}';
                    alertDiv.textContent = '{{ message }}';
                    document.querySelector('.modal-body').insertBefore(alertDiv, document.querySelector('.modal-body').firstChild);
                {% endfor %}
            {% endfor %}

            // Réinitialiser le formulaire quand la modal est fermée
            var addUserModal = document.getElementById('addUserModal');
            addUserModal.addEventListener('hidden.bs.modal', function () {
                var form = addUserModal.querySelector('form');
                if (form) {
                    form.reset();
                }
                // Supprimer les messages d'alerte
                var alerts = addUserModal.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    alert.remove();
                });
            });
        });
    </script>

    <!-- Delete User Modals -->
    {% for user in users %}
    <div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmer la suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>{{ user.nom }} {{ user.prenom }}</strong> ?</p>
                    <p class="text-danger"><small>Cette action est irréversible.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <form action="{{ path('admin_user_delete', {'id': user.id}) }}" method="POST" style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
                        <button type="submit" class="btn btn-danger">Supprimer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Modal des conditions d'utilisation -->
    <div class="modal fade" id="conditionsModal" tabindex="-1" aria-labelledby="conditionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conditionsModalLabel">Conditions d'utilisation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4>Conditions Générales d'Utilisation</h4>
                    <p>Dernière mise à jour : {{ "now"|date("d/m/Y") }}</p>
                    
                    <h5>1. Acceptation des conditions</h5>
                    <p>En utilisant cette plateforme, vous acceptez de vous conformer aux présentes Conditions Générales d'Utilisation. Si vous n'acceptez pas ces conditions, veuillez ne pas utiliser cette plateforme.</p>
                    
                    <h5>2. Description du service</h5>
                    <p>Notre plateforme propose des services de mise en relation entre freelances, formateurs, employeurs et administrateurs dans le cadre de projets professionnels.</p>
                    
                    <h5>3. Inscription et comptes utilisateurs</h5>
                    <p>Pour utiliser certaines fonctionnalités de notre plateforme, vous devez créer un compte. Vous êtes responsable de maintenir la confidentialité de vos identifiants et de toutes les activités qui se produisent sous votre compte.</p>
                    
                    <h5>4. Données personnelles</h5>
                    <p>Nous recueillons et traitons vos données personnelles conformément à notre politique de confidentialité. En utilisant notre plateforme, vous consentez à cette collecte et à ce traitement.</p>
                    
                    <h5>5. Propriété intellectuelle</h5>
                    <p>Tous les contenus présents sur cette plateforme sont protégés par des droits de propriété intellectuelle. Toute reproduction non autorisée est interdite.</p>
                    
                    <h5>6. Limitation de responsabilité</h5>
                    <p>Nous ne pouvons garantir que notre plateforme sera exempte d'erreurs ou d'interruptions. Nous ne sommes pas responsables des dommages indirects résultant de l'utilisation de notre plateforme.</p>
                    
                    <h5>7. Modification des conditions</h5>
                    <p>Nous nous réservons le droit de modifier ces conditions à tout moment. Les modifications prennent effet dès leur publication sur la plateforme.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">J'ai compris</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
